outputs:
  - 'Remediation.Output'
schemaVersion: '0.3'
description: |
  ### Document name - ASR-CNXC_EnableAPIGatewayLogging

  ## What does this document do?
  Enables appropriate Generic Logging:


  ## Input Parameters
  * AutomationAssumeRole: (Required) The Amazon Resource Name (ARN) of the AWS Identity and Access Management (IAM) role that allows Systems Manager Automation to perform the actions on your behalf.
  * ResourceId:           (Required) The Resource ID
  * ResourceType:         (Required) Resource Type
  * AccountId:            (Required) AWS Account #
  * Region:               (Required) AWS Region

  ## Output Parameters
  * Remediation.Output: STDOUT and messages from the remediation steps.
assumeRole: '{{ AutomationAssumeRole }}'
parameters:
  AutomationAssumeRole:
    description: '(Required) The ARN of the role that allows Automation to perform the actions on your behalf.'
    type: 'String'
    allowedPattern: "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
  AccountId:
    description: 'Account ID of the account for the finding'
    type: 'String'
    allowedPattern: '^[0-9]{12}$'
  ResourceId:
    description: 'The ARN of the resource'
    type: 'String'
    allowedPattern: '(.*)$'
  Region:
    description: 'The REGION of the resource'
    type: 'String'
    allowedPattern: "^[a-z]{2}(?:-gov)?-[a-z]+-\\d$"
  ResourceType:
    description: 'The Type of the resource (ie AwsApiGatewayStage for REST and AwsApiGatewayV2Stage for v2)'
    type: 'String'
    allowedPattern: '^(AwsElbv2LoadBalancer|AwsApiGatewayStage|AwsStepFunctionsStateMachine|AwsApiGatewayV2Stage|AwsCloudFrontDistribution|AwsStepFunctionsStateMachine|AwsS3Bucket)$'
mainSteps:
  - outputs:
      - Type: 'StringMap'
        Name: 'Output'
        Selector: '$.Payload.response'
      - Type: 'String'
        Name: 'LoggingBucket'
        Selector: '$.Payload.loggingBucketName'
    inputs:
      Script: |-
        %%SCRIPT=CNXC_CreateGenericLoggingBucket.py%%
      Runtime: 'python3.11'
      InputPayload:
        ResourceId: '{{ResourceId}}'
        ResourceType: '{{ResourceType}}'
      Handler: 'runbook_handler'
    name: 'CreateBucket'
    action: 'aws:executeScript'
    isEnd: false
  - outputs:
      - Type: 'StringMap'
        Name: 'Output'
        Selector: '$.Payload.response'
    inputs:
      Script: |-
        %%SCRIPT=CNXC_ApplyGenericLogging.py%%
      Runtime: 'python3.11'
      InputPayload:
        AccountId: '{{global:ACCOUNT_ID}}'
        ResourceId: '{{ResourceId}}'
        Region: '{{global:REGION}}'
        LoggingBucket: '{{CreateBucket.LoggingBucket}}'
        ResourceType: '{{ResourceType}}'
      Handler: 'runbook_handler'
    name: 'Remediation'
    action: 'aws:executeScript'
    isEnd: true
